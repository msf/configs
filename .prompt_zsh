#!/bin/zsh

# get the name of the branch we are on
my_vcs_info() {
    vcs_info
    echo "$vcs_info_msg_0_"
}

setprompt_simple() {
    autoload -U colors
    colors
    autoload -Uz vcs_info
    vcs_info
    zstyle ':vcs_info:*' formats "(%s)[%b] "
    zstyle ':vcs_info:*' actionformats "(%s)[%b|%a] "
    setopt prompt_subst

    for COLOR in BLUE RED GREEN YELLOW WHITE GREY BLACK PURPLE CYAN; do
        eval PR_$COLOR='%{$fg[${(L)COLOR}]%}'
        eval PR_BOLD_$COLOR='%{$fg_bold[${(L)COLOR}]%}'
    done

    PR_RESET="%{$reset_color%}"

    PROMPT='$PR_BLUE%n$PR_WHITE@$PR_BOLD_YELLOW%m $PR_BLUE%c $PR_RESET$(my_vcs_info)$PR_BLUE%% $PR_RESET'
}

# setprompt_simple

# https://github.com/justjanne/powerline-go
function powerline_precmd() {
    if [ ! -x $GOPATH/bin/powerline-go ]; then
        echo "please install: go get -u github.com/justjanne/powerline-go"
        setprompt_simple
    else
        PS1="$($GOPATH/bin/powerline-go -mode flat -error $? -shell zsh)"
    fi
}

function install_powerline_precmd() {
  for s in "${precmd_functions[@]}"; do
    if [ "$s" = "powerline_precmd" ]; then
      return
    fi
  done
  precmd_functions+=(powerline_precmd)
}

if [ "$TERM" != "linux" ]; then
    prompt_off_setup
    install_powerline_precmd
fi
